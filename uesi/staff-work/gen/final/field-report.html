<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated Field Report</title>
    <meta property="og:site_name" content="UESI Staff Work">
    <meta property="og:title" content="Generated Field Report">
    <meta property="og:description" content="Generate Field Report for UESI Staff Work.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-color: #075E54;
            --primary-dark: #054a43;
            --text-dark: #333333;
            --text-gray: #666666;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-light: #eeeeee;
            --shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .action-bar {
            background: var(--primary-color);
            color: var(--text-light);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .app-title {
            font-size: 1.65rem;
            font-weight: 600;
            color: var(--text-light);
            letter-spacing: 0.025rem;
        }

        .menu-button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 2.25rem;
            cursor: pointer;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
            margin-right: 1rem;
        }

        .menu-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .report-container {
            background-color: var(--bg-white);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: var(--shadow);
            max-width: 800px;
            width: 100%;
            margin-top: 6rem;
            font-size: 0.95rem;
        }

        .report-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .report-header p {
            font-size: 1.2rem;
            margin-bottom: 0.2rem;
            color: #000;
            font-weight: 600;
            text-align: center;
        }

        .report-header .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .staff-info {
            font-size: 1.05rem;
            text-align: center; /* Centered as per new example*/
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: #000;
        }
        /* No span-specific color here to match provided example */

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px auto; /* Centered and matching example */
            font-size: 0.9em; /* Adjust to match example more closely */
        }

        .report-table th,
        .report-table td {
            border: 1px solid #444; /* Darker border matching example */
            padding: 8px;
            text-align: center; /* Default to center as per example */
            vertical-align: top;
            word-wrap: break-word;
        }

        .report-table th {
            background-color: #f2f2f2;
            font-weight: bold; /* Bold as per example */
        }

        /* Adjusted widths for displayed table to match PDF proportions */
        .report-table colgroup col:nth-child(1) { width: 8%; } /* Sl. No */
        .report-table colgroup col:nth-child(2) { width: 12%; } /* Date */
        .report-table colgroup col:nth-child(3) { width: 12%; } /* DAY */
        .report-table colgroup col:nth-child(4) { width: 18%; } /* Zone/Division */
        .report-table colgroup col:nth-child(5) { width: 50%; } /* Purpose */


        .no-data-message {
            text-align: center;
            color: var(--text-gray);
            font-style: italic;
            margin-top: 20px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-top: 50px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .export-button-container {
            margin-top: 20px;
            text-align: center;
            width: 100%;
            max-width: 800px;
        }

        .export-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .export-btn:hover {
            background-color: var(--primary-dark);
        }

        .export-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .export-dialog-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .export-dialog-content {
            background: var(--bg-white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
            max-width: 350px;
            width: 90%;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .export-dialog-overlay.active .export-dialog-content {
            transform: translateY(0);
            opacity: 1;
        }

        .export-dialog-content h3 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .export-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .export-option-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 15px 10px;
            border-radius: 5px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .export-option-btn:hover {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }

        .export-option-btn i {
            font-size: 1.5rem;
        }

        .export-option-btn:hover i {
            color: var(--text-light);
        }

        .export-option-btn.excel-option:hover {
            background-color: #217346;
            border-color: #217346;
        }

        .export-option-btn.pdf-option:hover {
            background-color: #DC382C;
            border-color: #DC382C;
        }

        .export-option-btn.doc-option:hover {
            background-color: #2B579A;
            border-color: #2B579A;
        }

        .export-dialog-close {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        .export-dialog-close:hover {
            background-color: #c82333;
        }
    </style>
</head>

<body>
    <div class="action-bar">
        <div style="display: flex; align-items: center;">
            <button class="menu-button" id="menuButton" onclick="history.back()">
                <i class="fas fa-arrow-left" style="color: white;"></i>
            </button>
            <span class="app-title" style="color: white;">Generated Report</span>
        </div>
    </div>

    <div class="report-container" id="reportContent" style="display: none;">
        <div class="report-header">
            <p style="font-size: 1.2rem; margin-bottom: 0.2rem; color: #000; font-weight: 600;">Union of Evangelical
                Students of India - <span id="staffState"></span></p>
            <h1 class="report-title" id="reportGeneratedTitle">FIELD REPORT - [MONTH] [YEAR]</h1>
            <h2 class="staff-info">Name: <span id="staffInfoName"></span> &nbsp;&nbsp;&nbsp; <span id="staffInfoBase"></span></h2>
        </div>
        <table class="report-table" id="fieldReportTable">
            <colgroup>
                <col style="width: 8%;"> <col style="width: 12%;"> <col style="width: 12%;"> <col style="width: 18%;"> <col style="width: 50%;"> </colgroup>
            <thead>
                <tr>
                    <th>Sl. No</th>
                    <th>Date</th>
                    <th>DAY</th>
                    <th>Zone / Division</th>
                    <th>Purpose</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <p class="no-data-message" id="noDataMessage" style="display: none;">No report data found for the selected
            period.</p>
    </div>

    <div class="export-button-container">
        <button id="exportReportBtn" class="export-btn" style="display: none;">
            <i class="fas fa-share-square"></i> Export / Share Document
        </button>
    </div>

    <div class="loader" id="loader"></div>

    <div class="export-dialog-overlay" id="exportDialogOverlay">
        <div class="export-dialog-content">
            <h3>Export Report As:</h3>
            <div class="export-options-grid">
                <button class="export-option-btn excel-option" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i> Excel (CSV)
                </button>
                <button class="export-option-btn pdf-option" id="exportPdfBtn">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="export-option-btn doc-option" id="exportDocBtn">
                    <i class="fas fa-file-word"></i> Word (HTML)
                </button>
            </div>
            <button class="export-dialog-close" id="closeExportDialogBtn">Close</button>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <script>
        // Firebase Config (consistent with your other apps)
        var firebaseConfig = {
            apiKey: "0AzyPiDT3wSi6WAuNX7YzbyJcvUgV0nyoxMwahn0",
            authDomain: "uesi-ap-default-rtdb.firebaseio.com",
            databaseURL: "https://uesi-ap-default-rtdb.firebaseio.com",
            projectId: "uesi-ap"
        };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();

        // --- Get URL Parameters ---
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const userName = getQueryParam('name');
        const userEmail = getQueryParam('email');
        const userBase = getQueryParam('base');
        const userState = getQueryParam('state');
        const selectedMonthNum = getQueryParam('month');
        const selectedYear = getQueryParam('year');

        // Display basic staff info
        document.getElementById('staffInfoName').textContent = userName || 'N/A';
        document.getElementById('staffInfoBase').textContent = userBase || 'N/A';
        document.getElementById('staffState').textContent = userState || 'N/A';

        // --- Set Report Title ---
        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        const monthName = monthNames[parseInt(selectedMonthNum) - 1];

        if (monthName && selectedYear) {
            document.getElementById('reportGeneratedTitle').textContent = `FIELD REPORT - ${monthName.toUpperCase()} ${selectedYear}`;
        } else {
            document.getElementById('reportGeneratedTitle').textContent = `FIELD REPORT`;
        }

        // --- Fetch Data from Firebase ---
        let fieldReportRef = null;
        let safeUserEmail = null;
        let reportDataForExport = [];

        if (userEmail) {
            safeUserEmail = userEmail.replace(/\./g, '_');
            fieldReportRef = database.ref(`apps/uesi/staff-work/users/${safeUserEmail}/userData/Field_Report`);
        } else {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('noDataMessage').textContent = 'Error: User email not provided. Cannot fetch report.';
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('reportContent').style.display = 'block';
            console.error("User email missing from URL.");
        }


        if (fieldReportRef && selectedYear && selectedMonthNum) {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('exportReportBtn').style.display = 'none';

            fieldReportRef.orderByKey().startAt(`${selectedYear}-${String(selectedMonthNum).padStart(2, '0')}-01`).endAt(`${selectedYear}-${String(selectedMonthNum).padStart(2, '0')}-31`)
                .once('value', function (snapshot) {
                    document.getElementById('loader').style.display = 'none';
                    const tableBody = document.getElementById('fieldReportTable').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = '';

                    let serialNo = 1;
                    const rawData = [];

                    snapshot.forEach(function (dateSnapshot) {
                        const dateKey = dateSnapshot.key;
                        const dateData = dateSnapshot.val();

                        if (dateData && typeof dateData === 'object') {
                            rawData.push({ id: dateKey, date: dateKey, ...dateData });
                        }
                    });

                    rawData.sort((a, b) => new Date(a.date) - new Date(b.date));

                    if (rawData.length === 0) {
                        document.getElementById('noDataMessage').style.display = 'block';
                        document.getElementById('reportContent').style.display = 'block';
                        return;
                    }

                    let previousEntry = null;
                    rawData.forEach(function (data) {
                        const row = tableBody.insertRow();
                        const dateObj = new Date(data.date + 'T12:00:00');
                        const formattedDate = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}`;

                        let currentPurpose = data.purpose || '';
                        let currentZone = data.zone || '';
                        let currentDay = data.day || '';

                        let displayZone = currentZone;
                        let displayPurpose = currentPurpose;

                        const specialPurposeKeywords = ['day off', 'preparation', 'holidays'];
                        const isSpecialPurpose = specialPurposeKeywords.some(keyword => currentPurpose.toLowerCase().includes(keyword.toLowerCase()));

                        if (previousEntry && !isSpecialPurpose) {
                            const prevDateObj = new Date(previousEntry.date + 'T12:00:00');
                            const daysDiff = (dateObj - prevDateObj) / (1000 * 60 * 60 * 24);

                            if (daysDiff === 1 && currentZone === previousEntry.zone && currentPurpose === previousEntry.purpose) {
                                displayZone = '';
                                displayPurpose = '';
                            }
                        }

                        row.insertCell(0).textContent = serialNo++;
                        row.insertCell(1).textContent = formattedDate;
                        row.insertCell(2).textContent = currentDay;
                        row.insertCell(3).textContent = displayZone;
                        row.insertCell(4).textContent = displayPurpose;

                        reportDataForExport.push({
                            "Sl. No": serialNo - 1,
                            "Date": formattedDate,
                            "DAY": currentDay,
                            "Zone / Division": displayZone,
                            "Purpose": displayPurpose
                        });

                        previousEntry = data;
                    });

                    document.getElementById('reportContent').style.display = 'block';
                    document.getElementById('exportReportBtn').style.display = 'block';
                })
                .catch(function (error) {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('noDataMessage').textContent = `Error fetching data: ${error.message}`;
                    document.getElementById('noDataMessage').style.display = 'block';
                    document.getElementById('reportContent').style.display = 'block';
                    console.error("Firebase data fetch error:", error);
                });
        } else if (!fieldReportRef) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('noDataMessage').textContent = 'Error: Cannot establish Firebase connection without email.';
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('reportContent').style.display = 'block';
        }

        // --- Export / Share Logic ---
        const exportDialogOverlay = document.getElementById('exportDialogOverlay');
        const exportReportBtn = document.getElementById('exportReportBtn');
        const closeExportDialogBtn = document.getElementById('closeExportDialogBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportDocBtn = document.getElementById('exportDocBtn');

        exportReportBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.add('active');
        });

        closeExportDialogBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.remove('active');
        });

        exportDialogOverlay.addEventListener('click', (event) => {
            if (event.target === exportDialogOverlay) {
                exportDialogOverlay.classList.remove('active');
            }
        });

        exportExcelBtn.addEventListener('click', () => {
            exportAsCsv(reportDataForExport, `${userName}_Field_Report_${monthName}_${selectedYear}.csv`);
            exportDialogOverlay.classList.remove('active');
        });

        exportPdfBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.remove('active');
            
            // For PDF, we want to capture the main report-container div
            // because it contains the header and table with the CSS styles applied.
            const contentToCapture = document.getElementById('reportContent'); 
            
            // Temporarily adjust some styles for capture if needed, or rely on existing CSS
            // Example: contentToCapture.style.width = '794px'; // A4 width for better rendering if not already set by max-width

            html2canvas(contentToCapture, { scale: 2, logging: false, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' units, 'a4' size
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save(`${userName}_Field_Report_${monthName}_${selectedYear}.pdf`);
                
            }).catch(error => {
                console.error("Error generating PDF:", error);
                alert("Failed to generate PDF. Please try again.");
            });
        });

        exportDocBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.remove('active');
            
            // Get the entire report content div, which contains the header and the main table
            const contentToExport = document.getElementById('reportContent');

            // Create a clone to manipulate styles without affecting the visible page
            const clonedContent = contentToExport.cloneNode(true);

            // Apply inline styles to the cloned content to ensure consistent rendering in Word
            clonedContent.style.cssText = `
                font-family: Arial, sans-serif;
                color: #000;
                width: 794px; /* A4 width for consistency */
                font-size: 14px;
                line-height: 1.4;
                padding: 20px;
                box-sizing: border-box;
                background-color: #fff;
            `;

            // Adjust header styles in clone
            const headerP = clonedContent.querySelector('.report-header p');
            if (headerP) headerP.style.cssText = `margin: 0; font-size: 14px; font-weight: bold; text-align: center;`;
            
            const headerH1 = clonedContent.querySelector('.report-header h1');
            if (headerH1) headerH1.style.cssText = `margin: 5px 0 10px; font-size: 16px; font-weight: bold; text-transform: uppercase; text-align: center; color: #075E54;`;

            // Adjust staff info styles in clone
            const staffInfoH4 = clonedContent.querySelector('h4.staff-info');
            if (staffInfoH4) staffInfoH4.style.cssText = `text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 14px;`;
            
            // Get the table and apply inline styles directly
            const table = clonedContent.querySelector('.report-table');
            if (table) {
                table.style.cssText = `width: 100%; border-collapse: collapse; margin: 20px auto; font-size: 13px; font-family: Arial, sans-serif; table-layout: fixed;`;
                
                // Set column widths in the cloned table's colgroup
                let colgroupHtml = '<colgroup>';
                const colWidths = {
                    "Sl. No": "8%",
                    "Date": "12%",
                    "DAY": "12%",
                    "Zone / Division": "18%",
                    "Purpose": "50%"
                };
                Object.values(colWidths).forEach(width => {
                    colgroupHtml += `<col style="width:${width};">`;
                });
                colgroupHtml += '</colgroup>';
                table.insertAdjacentHTML('afterbegin', colgroupHtml);

                table.querySelectorAll('th').forEach(th => {
                    th.style.cssText = `border: 1px solid #444; padding: 8px; text-align: center; background-color: #f2f2f2; font-weight: bold; white-space: nowrap;`;
                });
                table.querySelectorAll('td').forEach(td => {
                    td.style.cssText = `border: 1px solid #444; padding: 8px; vertical-align: top; word-wrap: break-word;`;
                    // Specific alignment for columns
                    const headerText = td.closest('table').querySelector('th:nth-child(' + (td.cellIndex + 1) + ')').textContent.trim();
                    if (headerText === 'Sl. No' || headerText === 'Date' || headerText === 'DAY') {
                        td.style.textAlign = 'center';
                    } else {
                        td.style.textAlign = 'left';
                    }
                });
            }

            const fullHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>${userName} Field Report - ${monthName} ${selectedYear}</title>
                </head>
                <body>
                    ${clonedContent.innerHTML}
                </body>
                </html>
            `;

            const blob = new Blob([fullHtml], { type: 'application/msword;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });


        function exportAsCsv(data, filename) {
            if (!data || data.length === 0) {
                alert('No data to export!');
                return;
            }

            let csvContent = "";
            csvContent += "\uFEFF";

            const headers = Object.keys(data[0]);
            csvContent += headers.join(",") + "\r\n";

            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] === null || row[header] === undefined ? '' : String(row[header]);
                    value = value.replace(/"/g, '""');
                    if (value.includes(',') || value.includes('"') || value.includes('\n') || value.includes('\r')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvContent += values.join(",") + "\r\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>

</html>
