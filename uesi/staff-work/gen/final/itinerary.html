<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        (function () {
            // Keys to retain in localStorage
            const keysToRetain = ["bbsRole", "bbsName"];

            // Retrieve the values of the keys to retain
            const valuesToRetain = {};
            keysToRetain.forEach((key) => {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    valuesToRetain[key] = value;
                }
            });

            // Clear all keys in localStorage except the specified keys
            Object.keys(localStorage).forEach((key) => {
                if (!keysToRetain.includes(key)) {
                    localStorage.removeItem(key);
                }
            });

            // Restore the retained key-value pairs
            Object.keys(valuesToRetain).forEach((key) => {
                localStorage.setItem(key, valuesToRetain[key]);
            });

            console.log("LocalStorage cleared except for:", keysToRetain);

            // Clear sessionStorage
            sessionStorage.clear();
            console.log("SessionStorage cleared.");

            // Clear IndexedDB data
            const clearIndexedDB = () => {
                if (!window.indexedDB) {
                    console.warn("IndexedDB is not supported by this browser.");
                    return;
                }
                indexedDB.databases().then((databases) => {
                    databases.forEach((db) => {
                        indexedDB.deleteDatabase(db.name);
                        console.log(`Deleted IndexedDB: ${db.name}`);
                    });
                }).catch((error) => {
                    console.error("Error clearing IndexedDB:", error);
                });
            };

            // Clear browser cache
            const clearCache = () => {
                if ("caches" in window) {
                    caches.keys().then((cacheNames) => {
                        cacheNames.forEach((cacheName) => {
                            caches.delete(cacheName);
                            console.log(`Deleted Cache: ${cacheName}`);
                        });
                    }).catch((error) => {
                        console.error("Error clearing cache:", error);
                    });
                } else {
                    console.warn("Cache API is not supported by this browser.");
                }
            };

            // Execute cleanup functions
            clearIndexedDB();
            clearCache();

            console.log(`All data cleared except for ${keysToRetain.join(", ")} in localStorage.`);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated Itinerary</title>
    <meta property="og:site_name" content="UESI Staff Work">
    <meta property="og:title" content="Generated Itinerary Report">
    <meta property="og:description" content="Generate Itinerary Report for UESI Staff Work.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-color: #075E54;
            --primary-dark: #054a43;
            --text-dark: #333333;
            --text-gray: #666666;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-light: #eeeeee;
            --shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            /* Changed font-family to Times New Roman */
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .action-bar {
            background: var(--primary-color);
            color: var(--text-light);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .app-title {
            font-size: 1.65rem;
            font-weight: 600;
            color: var(--text-light);
            letter-spacing: 0.025rem;
        }

        .menu-button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 2.25rem;
            cursor: pointer;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
            margin-right: 1rem;
        }

        .menu-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .report-container {
            background-color: var(--bg-white);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: var(--shadow);
            max-width: 800px;
            width: 100%;
            margin-top: 6rem;
            font-size: 0.95em;
            /* Use em or rem for scalability */
        }

        .table-scroll-wrapper {
            overflow-x: auto;
            width: 100%;
            margin-top: 0;
            -webkit-overflow-scrolling: touch;
        }

        .report-table {
            width: 100%;
            min-width: 700px;
            /* Ensures table doesn't shrink too much */
            border-collapse: collapse;
            margin: 0 auto;
            font-size: 1em;
            /* Ensure table font size inherits or is explicitly set */
        }

        .report-table th,
        .report-table td {
            border: 1px solid #444;
            padding: 8px;
            /* Default padding for table cells */
            text-align: center;
            vertical-align: top;
            word-wrap: break-word;
        }

        /* Styles for the main report headers within the table */
        .report-table thead tr.report-main-header td {
            font-weight: bold;
            /* Changed to bold for Times New Roman */
            color: #000;
            text-align: center;
            padding: 8px 10px;
            /* Increased padding */
            font-size: 1.25em;
            /* Increased font size */
            border: 1px solid #444;
            /* Ensure borders */
        }

        .report-table thead tr.report-title-row td {
            font-size: 1.8em;
            /* Increased font size */
            font-weight: bold;
            /* Changed to bold for Times New Roman */
            color: var(--primary-color);
            text-align: center;
            padding: 8px 10px;
            /* Increased padding */
            border: 1px solid #444;
        }

        .report-table thead tr.staff-info-row td {
            font-size: 1.4em;
            /* Increased font size */
            font-weight: bold;
            /* Changed to bold for Times New Roman */
            color: #000;
            text-align: center;
            padding: 8px 10px;
            /* Increased padding */
            border: 1px solid #444;
        }

        /* Style for the actual table headers (Sl. No, Date, etc.) */
        .report-table thead tr:last-child th {
            background-color: #f2f2f2;
            font-weight: bold;
            padding: 8px;
            font-size: 1em;
            /* Relative to table font size */
        }

        /* Centered align Zone / Division and Purpose columns for display */
        .report-table td:nth-child(4),
        .report-table td:nth-child(5) {
            text-align: center;
            /* Changed from left to center */
        }

        /* Added for rowspan cells in the display table */
        .report-table td[rowspan] {
            vertical-align: middle;
        }

        .no-data-message {
            text-align: center;
            color: var(--text-gray);
            font-style: italic;
            margin-top: 20px;
        }

        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .export-button-container {
            margin-top: 20px;
            text-align: center;
            width: 100%;
            max-width: 800px;
        }

        .export-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .export-btn:hover {
            background-color: var(--primary-dark);
        }

        .export-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .export-dialog-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .export-dialog-content {
            background: var(--bg-white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
            max-width: 350px;
            width: 90%;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .export-dialog-overlay.active .export-dialog-content {
            transform: translateY(0);
            opacity: 1;
        }

        .export-dialog-content h3 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .export-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .export-option-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 15px 10px;
            border-radius: 5px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .export-option-btn:hover {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }

        .export-option-btn i {
            font-size: 1.5rem;
        }

        .export-option-btn:hover i {
            color: var(--text-light);
        }

        .export-option-btn.excel-option:hover {
            background-color: #217346;
            border-color: #217346;
        }

        .export-option-btn.pdf-option:hover {
            background-color: #DC382C;
            border-color: #DC382C;
        }

        .export-option-btn.doc-option:hover {
            background-color: #2B579A;
            border-color: #2B579A;
        }

        .export-dialog-close {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        .export-dialog-close:hover {
            background-color: #c82333;
        }
    </style>
</head>

<body>
    <div class="action-bar">
        <div style="display: flex; align-items: center;">
            <button class="menu-button" id="menuButton" onclick="history.back()">
                <i class="fas fa-arrow-left" style="color: white;"></i>
            </button>
            <span class="app-title" style="color: white;">Generated Itinerary</span>
        </div>
    </div>

    <div class="report-container" id="reportContent" style="display: none;">
        <div class="table-scroll-wrapper">
            <table class="report-table" id="fieldReportTable">
                <thead>
                    <tr class="report-main-header">
                        <td colspan="5">Union of Evangelical Students of India - <span id="staffState"></span></td>
                    </tr>
                    <tr class="report-title-row">
                        <td colspan="5" id="reportGeneratedTitle">ITINERARY - [MONTH] [YEAR]</td>
                    </tr>
                    <tr class="staff-info-row">
                        <td colspan="5">NAME: <span id="staffInfoName"></span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            Base: <span id="staffInfoBase"></span>
                        </td>
                    </tr>
                    <tr>
                        <th>Sl. No</th>
                        <th>Date</th>
                        <th>DAY</th>
                        <th>Zone / Division</th>
                        <th>Purpose</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <p class="no-data-message" id="noDataMessage" style="display: none;">No report data found for the selected
            period.</p>
    </div>

    <div class="export-button-container">
        <button id="exportReportBtn" class="export-btn" style="display: none;">
            <i class="fas fa-share-square"></i> Export / Share Document
        </button>
    </div>

    <div id="exportLoadingOverlay" class="loader-overlay" style="display: none;">
        <div class="loader"></div>
        <p style="margin-top: 15px;">Generating document...</p>
    </div>

    <div class="loader" id="loader"></div>

    <div class="export-dialog-overlay" id="exportDialogOverlay">
        <div class="export-dialog-content">
            <h3>Export Report As:</h3>
            <div class="export-options-grid">
                <button class="export-option-btn pdf-option" id="exportPdfBtn">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="export-option-btn excel-option" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button class="export-option-btn doc-option" id="exportDocBtn">
                    <i class="fas fa-file-word"></i> Word
                </button>
            </div>
            <button class="export-dialog-close" id="closeExportDialogBtn">Close</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Firebase Config
        var firebaseConfig = {
            apiKey: "0AzyPiDT3wSi6WAuNX7YzbyJcvUgV0nyoxMwahn0",
            authDomain: "uesi-ap-default-rtdb.firebaseio.com",
            databaseURL: "https://uesi-ap-default-rtdb.firebaseio.com",
            projectId: "uesi-ap"
        };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();

        // Get URL Parameters
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            // Decode URI component to handle %20 and other encoded characters
            return decodeURIComponent(urlParams.get(param) || '');
        }

        const userName = getQueryParam('name') || '';
        const userEmail = getQueryParam('email') || 'sample@test.com';
        const userBase = getQueryParam('base') || '';
        const userState = getQueryParam('state') || '';
        const selectedMonthNum = getQueryParam('month') || '';
        const selectedYear = getQueryParam('year') || '';

        // Display basic staff info
        document.getElementById('staffInfoName').textContent = userName;
        document.getElementById('staffInfoBase').textContent = userBase;
        document.getElementById('staffState').textContent = userState;

        // Set Report Title
        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        const monthName = monthNames[parseInt(selectedMonthNum) - 1];
        if (monthName && selectedYear) {
            document.getElementById('reportGeneratedTitle').textContent = `ITINERARY - ${monthName.toUpperCase()} ${selectedYear}`;
        }

        // This array will store the structured data for export, including rowspan info
        let processedTableDataForExport = [];

        // Helper functions
        function isSpecialPurpose(purpose) {
            const specialKeywords = ['day off', 'preparation', 'holidays', 'leave', 'sick'];
            return specialKeywords.some(keyword =>
                purpose.toLowerCase().includes(keyword.toLowerCase())
            );
        }

        function isConsecutiveDay(date1, date2) {
            const d1 = new Date(date1 + 'T12:00:00'); // Add time to avoid timezone issues
            const d2 = new Date(date2 + 'T12:00:00');
            const timeDiff = d2.getTime() - d1.getTime();
            const dayDiff = timeDiff / (1000 * 3600 * 24);
            return dayDiff === 1;
        }

        /**
         * Processes raw data to identify groups for rowspan and populate the HTML table.
         * Also prepares data for export with explicit rowspan information.
         */
        function processAndPopulateTable(rawData) {
            const tableBody = document.getElementById('fieldReportTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear existing content
            processedTableDataForExport = []; // Reset export data

            if (rawData.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }

            let serialNo = 1;
            let i = 0;
            while (i < rawData.length) {
                const startData = rawData[i];
                let groupCount = 1;
                let j = i + 1;

                // Check for consecutive identical entries to group
                // Conditions: not a special purpose, same zone, same purpose, consecutive day
                while (j < rawData.length &&
                    !isSpecialPurpose(startData.purpose) &&
                    startData.zone === rawData[j].zone &&
                    startData.purpose === rawData[j].purpose &&
                    isConsecutiveDay(rawData[j - 1].date, rawData[j].date)) {
                    groupCount++;
                    j++;
                }

                // --- HTML Table Generation (with rowspan) ---
                const row = tableBody.insertRow();
                const formattedDate = new Date(startData.date + 'T12:00:00');
                row.insertCell(0).textContent = serialNo++;
                row.insertCell(1).textContent = `${String(formattedDate.getDate()).padStart(2, '0')}/${String(formattedDate.getMonth() + 1).padStart(2, '0')}/${formattedDate.getFullYear()}`;
                row.insertCell(2).textContent = startData.day;

                const zoneCell = row.insertCell(3);
                zoneCell.textContent = startData.zone;
                zoneCell.rowSpan = groupCount;
                zoneCell.style.verticalAlign = 'middle';
                zoneCell.style.textAlign = 'center'; // Centered

                const purposeCell = row.insertCell(4);
                purposeCell.textContent = startData.purpose;
                purposeCell.rowSpan = groupCount;
                purposeCell.style.verticalAlign = 'middle';
                purposeCell.style.textAlign = 'center'; // Centered

                // Populate subsequent rows for the group (only Sl. No, Date, Day)
                for (let k = 1; k < groupCount; k++) {
                    const subsequentRowData = rawData[i + k];
                    const subsequentRow = tableBody.insertRow();
                    const subFormattedDate = new Date(subsequentRowData.date + 'T12:00:00');
                    subsequentRow.insertCell(0).textContent = serialNo++;
                    subsequentRow.insertCell(1).textContent = `${String(subFormattedDate.getDate()).padStart(2, '0')}/${String(subFormattedDate.getMonth() + 1).padStart(2, '0')}/${subFormattedDate.getFullYear()}`;
                    subsequentRow.insertCell(2).textContent = subsequentRowData.day;
                }

                // --- Prepare data for export (also with rowspan info) ---
                // We store the data in a way that allows reconstruction of the merged table structure
                processedTableDataForExport.push({
                    type: 'firstInGroup',
                    slNoStart: serialNo - groupCount, // Starting Sl. No for this group
                    count: groupCount,
                    date: startData.date,
                    day: startData.day,
                    zone: startData.zone,
                    purpose: startData.purpose
                });

                for (let k = 1; k < groupCount; k++) {
                    const currentItem = rawData[i + k];
                    processedTableDataForExport.push({
                        type: 'subsequentInGroup',
                        slNo: serialNo - groupCount + k, // Individual Sl. No
                        date: currentItem.date,
                        day: currentItem.day
                    });
                }

                i = j; // Move to the next un-grouped item
            }
            document.getElementById('noDataMessage').style.display = 'none'; // Hide if data is populated
            document.getElementById('reportContent').style.display = 'block';
            document.getElementById('exportReportBtn').style.display = 'block';
        }


        // Export Dialog Logic
        const exportDialogOverlay = document.getElementById('exportDialogOverlay');
        const exportReportBtn = document.getElementById('exportReportBtn');
        const closeExportDialogBtn = document.getElementById('closeExportDialogBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn'); // Corrected var name
        const exportDocBtn = document.getElementById('exportDocBtn');
        const exportLoadingOverlay = document.getElementById('exportLoadingOverlay');

        function showExportLoading() {
            exportLoadingOverlay.style.display = 'flex';
        }

        function hideExportLoading() {
            exportLoadingOverlay.style.display = 'none';
        }

        exportReportBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.add('active');
        });

        closeExportDialogBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.remove('active');
        });

        exportDialogOverlay.addEventListener('click', (event) => {
            if (event.target === exportDialogOverlay) {
                exportDialogOverlay.classList.remove('active');
            }
        });

        // Export functions
        exportPdfBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.remove('active');
            generatePDF();
        });

        exportExcelBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.remove('active');
            generateExcel();
        });

        exportDocBtn.addEventListener('click', () => {
            exportDialogOverlay.classList.remove('active');
            generateWord();
        });

        // --- PDF Export (using generated HTML with rowspan) ---
        function generatePDF() {
            showExportLoading();

            // Generate HTML content specifically for PDF, including rowspan
            const pdfHtmlContent = generateExportHtmlContent(processedTableDataForExport, userName, userBase, userState, monthName, selectedYear, 'pdf');
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = `
                position: absolute;
                left: -9999px;
                top: -9999px;
                display: block !important;
                /* Adjust width for PDF if necessary to fit content, a bit less than A4 print width */
                width: 760px; /* Adjusted from 794px, gives some padding */
                background-color: #fff;
                padding: 10mm; /* Use mm for consistent print size */
                box-sizing: border-box;
                font-family: 'Times New Roman', Times, serif; /* Apply Times New Roman for PDF */
                color: #000;
                line-height: 1.2; /* Tighter line height */
            `;
            tempDiv.innerHTML = pdfHtmlContent;
            document.body.appendChild(tempDiv);

            setTimeout(() => {
                html2canvas(tempDiv, {
                    scale: 2, // Keep scale high for better resolution
                    logging: false,
                    useCORS: true,
                    windowWidth: tempDiv.scrollWidth,
                    windowHeight: tempDiv.scrollHeight
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width; // Calculate image height to maintain aspect ratio
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Add image to PDF
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // If content exceeds one page, add more pages
                    while (heightLeft > 0) {
                        position = heightLeft - pageHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    doc.save(`${userName} Itinerary ${monthName} ${selectedYear}.pdf`);
                    document.body.removeChild(tempDiv);
                    hideExportLoading();
                }).catch(error => {
                    console.error("Error generating PDF:", error);
                    alert("Failed to generate PDF. Please try again.");
                    if (tempDiv.parentNode) {
                        document.body.removeChild(tempDiv);
                    }
                    hideExportLoading();
                });
            }, 100);
        }

        // --- Excel Export (with actual cell merging) ---
        function generateExcel() {
            showExportLoading();

            try {
                const wb = XLSX.utils.book_new();
                const ws_data = [];
                const merges = [];
                let currentRowIndex = 0; // Tracks the current row index in ws_data

                // Add main header rows with colspan and styles for Excel
                ws_data.push([`Union of Evangelical Students of India - ${userState}`]);
                merges.push({ s: { r: currentRowIndex, c: 0 }, e: { r: currentRowIndex, c: 4 } }); // Merge across 5 columns
                currentRowIndex++;

                ws_data.push([`ITINERARY - ${monthName ? monthName.toUpperCase() : ''} ${selectedYear}`]);
                merges.push({ s: { r: currentRowIndex, c: 0 }, e: { r: currentRowIndex, c: 4 } });
                currentRowIndex++;

                ws_data.push([`NAME: ${userName}      Base: ${userBase}`]);
                merges.push({ s: { r: currentRowIndex, c: 0 }, e: { r: currentRowIndex, c: 4 } });
                currentRowIndex++;

                ws_data.push([]); // Empty row as separator
                currentRowIndex++;

                // Add table headers
                ws_data.push(['Sl. No', 'Date', 'DAY', 'Zone / Division', 'Purpose']);
                const tableHeaderRowIndex = currentRowIndex; // Store index of actual table headers
                currentRowIndex++;

                // Populate table data with merges
                processedTableDataForExport.forEach(item => {
                    const rowData = [];
                    if (item.type === 'firstInGroup') {
                        rowData.push(item.slNoStart);
                        const formattedDate = new Date(item.date + 'T12:00:00');
                        rowData.push(`${String(formattedDate.getDate()).padStart(2, '0')}/${String(formattedDate.getMonth() + 1).padStart(2, '0')}/${formattedDate.getFullYear()}`);
                        rowData.push(item.day);
                        rowData.push(item.zone);
                        rowData.push(item.purpose);

                        // Add merge info for Zone and Purpose columns
                        if (item.count > 1) {
                            merges.push({ s: { r: currentRowIndex, c: 3 }, e: { r: currentRowIndex + item.count - 1, c: 3 } }); // Zone column
                            merges.push({ s: { r: currentRowIndex, c: 4 }, e: { r: currentRowIndex + item.count - 1, c: 4 } }); // Purpose column
                        }
                    } else { // subsequentInGroup
                        rowData.push(item.slNo);
                        const formattedDate = new Date(item.date + 'T12:00:00');
                        rowData.push(`${String(formattedDate.getDate()).padStart(2, '0')}/${String(formattedDate.getMonth() + 1).padStart(2, '0')}/${formattedDate.getFullYear()}`);
                        rowData.push(item.day);
                        // Zone and Purpose columns are left empty for subsequent rows in a merge block
                        rowData.push('');
                        rowData.push('');
                    }
                    ws_data.push(rowData);
                    currentRowIndex++;
                });

                const ws = XLSX.utils.aoa_to_sheet(ws_data);

                // Apply merges
                if (merges.length > 0) {
                    ws['!merges'] = merges;
                }

                // Set column widths based on your specific request (converted to Excel's wch)
                // 8% for Sl.No, 12% for Date, 12% for Day, 18% for Zone/Division, 50% for Purpose
                ws['!cols'] = [
                    { wch: 6 },  // Sl. No (approx 8%)
                    { wch: 9 }, // Date (approx 12%)
                    { wch: 9 }, // DAY (approx 12%)
                    { wch: 14 }, // Zone / Division (approx 18%)
                    { wch: 38 }  // Purpose (approx 50%)
                ];


                // Apply styles (bold headers, alignment, font sizes, borders)
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cellAddress]) continue;

                        if (!ws[cellAddress].s) ws[cellAddress].s = {};

                        // Apply Times New Roman font to all cells
                        ws[cellAddress].s.font = { name: 'Times New Roman' };

                        // Main Report Headers (rows 0, 1, 2)
                        if (R >= 0 && R <= 2) {
                            // Increase font size slightly for these headers in Excel
                            ws[cellAddress].s.font.bold = true;
                            ws[cellAddress].s.font.sz = R === 1 ? 18 : 15; // Report title larger, others slightly larger
                            ws[cellAddress].s.alignment = { horizontal: 'center', vertical: 'center' };
                            ws[cellAddress].s.border = {
                                top: { style: "thin", color: { rgb: "444444" } },
                                bottom: { style: "thin", color: { rgb: "444444" } },
                                left: { style: "thin", color: { rgb: "444444" } },
                                right: { style: "thin", color: { rgb: "444444" } }
                            };
                            if (R === 1) ws[cellAddress].s.font.color = { rgb: "075E54" }; // Apply primary color to main title
                        }
                        // Table Headers (row `tableHeaderRowIndex`)
                        else if (R === tableHeaderRowIndex) {
                            ws[cellAddress].s.font.bold = true;
                            ws[cellAddress].s.font.sz = 12; // Adjusted table header font size
                            ws[cellAddress].s.alignment = { horizontal: 'center', vertical: 'center' };
                            ws[cellAddress].s.fill = { fgColor: { rgb: "F2F2F2" } }; // Light gray background
                            ws[cellAddress].s.border = {
                                top: { style: "thin", color: { rgb: "444444" } },
                                bottom: { style: "thin", color: { rgb: "444444" } },
                                left: { style: "thin", color: { rgb: "444444" } },
                                right: { style: "thin", color: { rgb: "444444" } }
                            };
                        }
                        // Table Data Rows
                        else if (R > tableHeaderRowIndex) {
                            ws[cellAddress].s.font.sz = 10; // Adjusted table data font size
                            ws[cellAddress].s.border = {
                                top: { style: "thin", color: { rgb: "444444" } },
                                bottom: { style: "thin", color: { rgb: "444444" } },
                                left: { style: "thin", color: { rgb: "444444" } },
                                right: { style: "thin", color: { rgb: "444444" } }
                            };

                            // Alignment for data cells
                            if (C >= 0 && C <= 2) { // Sl. No, Date, Day
                                ws[cellAddress].s.alignment = { horizontal: 'center', vertical: 'top' };
                            } else if (C >= 3 && C <= 4) { // Zone / Division, Purpose
                                ws[cellAddress].s.alignment = { horizontal: 'center', vertical: 'top' }; // Changed to center
                            }
                        }
                    }
                }

                // Adjust vertical alignment for the *first cell* of merged blocks for Zone/Purpose
                merges.forEach(merge => {
                    // Only apply if it's a merge on columns 3 or 4 and it's a data row
                    if ((merge.s.c === 3 || merge.s.c === 4) && merge.s.r > tableHeaderRowIndex) {
                        const firstCellAddress = XLSX.utils.encode_cell({ r: merge.s.r, c: merge.s.c });
                        if (ws[firstCellAddress] && ws[firstCellAddress].s) {
                            ws[firstCellAddress].s.alignment.vertical = 'center';
                        }
                    }
                });

                XLSX.utils.book_append_sheet(wb, ws, 'Itinerary Report');
                XLSX.writeFile(wb, `${userName} Itinerary ${monthName} ${selectedYear}.xlsx`);

                hideExportLoading();
            } catch (error) {
                console.error("Error generating Excel:", error);
                alert("Failed to generate Excel file. Please try again.");
                hideExportLoading();
            }
        }

        // --- Word Export (using generated HTML with rowspan) ---
        function generateWord() {
            showExportLoading();

            try {
                // Generate HTML content specifically for Word, including rowspan
                const wordHtmlContent = generateExportHtmlContent(processedTableDataForExport, userName, userBase, userState, monthName, selectedYear, 'word');

                const blob = new Blob([wordHtmlContent], {
                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${userName} Itinerary ${monthName} ${selectedYear}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                hideExportLoading();
            } catch (error) {
                console.error("Error generating Word document:", error);
                alert("Failed to generate Word document. Please try again.");
                hideExportLoading();
            }
        }

        /**
         * Generates the HTML content for PDF/Word exports, respecting rowspan.
         * Includes specific styles to fit content on one page for PDF.
         * @param {Array} data - The processed data from processAndPopulateTable.
         * @param {string} userName
         * @param {string} userBase
         * @param {string} userState
         * @param {string} monthName
         * @param {string} selectedYear
         * @param {string} formatType - 'pdf' or 'word' to apply format-specific styles
         * @returns {string} The HTML string for the document.
         */
        function generateExportHtmlContent(data, userName, userBase, userState, monthName, selectedYear, formatType) {
            const specifiedColWidths = {
                "Sl. No": "8%",
                "Date": "12%",
                "DAY": "12%",
                "Zone / Division": "18%",
                "Purpose": "50%"
            };

            let tableHtml = `
        <table border="1" style="width:100%; border-collapse: collapse; margin: 15px auto; table-layout: fixed;">
            <colgroup>
                <col style="width: ${specifiedColWidths["Sl. No"]};">
                <col style="width: ${specifiedColWidths["Date"]};">
                <col style="width: ${specifiedColWidths["DAY"]};">
                <col style="width: ${specifiedColWidths["Zone / Division"]};">
                <col style="width: ${specifiedColWidths["Purpose"]};">
            </colgroup>
            <thead>
                <tr class="export-report-main-header">
                    <td colspan="5">Union of Evangelical Students of India - ${userState || 'N/A'}</td>
                </tr>
                <tr class="export-report-title-row">
                    <td colspan="5">ITINERARY - ${monthName ? monthName.toUpperCase() : ''} ${selectedYear}</td>
                </tr>
                <tr class="export-staff-info-row">
                    <td colspan="5">NAME: ${userName || 'N/A'} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Base: ${userBase || 'N/A'}</td>
                </tr>
                <tr>`;

            const headers = ["Sl. No", "Date", "DAY", "Zone / Division", "Purpose"];

            let headerFontSize = formatType === 'pdf' ? '11px' : '13px';
            let headerStyles = `
        background-color:#f2f2f2;
        padding:${formatType === 'pdf' ? '5px' : '6px'};
        text-align:center;
        font-weight:bold;
        border:1px solid #444;
        white-space: nowrap;
        font-size:${headerFontSize};
    `;

            headers.forEach(header => {
                tableHtml += `<th style="${headerStyles} width:${specifiedColWidths[header]}">${header}</th>`;
            });

            tableHtml += `</tr></thead><tbody>`;

            const cellFontSize = formatType === 'pdf' ? '10px' : '12px';
            const cellPadding = formatType === 'pdf' ? '4px' : '5px';
            const cellStyles = `
        padding:${cellPadding};
        border:1px solid #444;
        word-wrap: break-word;
        font-size:${cellFontSize};
        text-align:center;
    `;

            data.forEach(item => {
                tableHtml += '<tr>';
                const formattedDate = new Date(item.date + 'T12:00:00');
                const dateStr = `${String(formattedDate.getDate()).padStart(2, '0')}/${String(formattedDate.getMonth() + 1).padStart(2, '0')}/${formattedDate.getFullYear()}`;

                tableHtml += `<td style="${cellStyles} width:${specifiedColWidths["Sl. No"]};">${item.type === 'firstInGroup' ? item.slNoStart : item.slNo}</td>`;
                tableHtml += `<td style="${cellStyles} white-space:nowrap; width:${specifiedColWidths["Date"]};">${dateStr}</td>`;
                tableHtml += `<td style="${cellStyles} white-space:nowrap; width:${specifiedColWidths["DAY"]};">${item.day}</td>`;

                if (item.type === 'firstInGroup') {
                    tableHtml += `<td rowspan="${item.count}" style="${cellStyles} vertical-align:middle; width:${specifiedColWidths["Zone / Division"]};">${item.zone}</td>`;
                    tableHtml += `<td rowspan="${item.count}" style="${cellStyles} vertical-align:middle; width:${specifiedColWidths["Purpose"]};">${item.purpose}</td>`;
                }

                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';

            const dynamicStyles = `
        <style>
            body {
                font-family: 'Times New Roman', Times, serif;
                margin: 0;
                padding: 0;
                color: #000;
            }
            .export-report-main-header td,
            .export-report-title-row td,
            .export-staff-info-row td {
                font-weight: bold;
                text-align: center;
                padding: ${formatType === 'pdf' ? '5px' : '8px'} 10px;
                border: 1px solid #444;
                font-family: 'Times New Roman', Times, serif;
            }
            .export-report-title-row td {
                color: #075E54;
                font-size: ${formatType === 'pdf' ? '15px' : '20px'};
            }
            .export-report-main-header td {
                font-size: ${formatType === 'pdf' ? '12px' : '15px'};
            }
            .export-staff-info-row td {
                font-size: ${formatType === 'pdf' ? '12px' : '15px'};
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 15px auto;
                table-layout: fixed;
            }
            th, td {
                font-family: 'Times New Roman', Times, serif;
                vertical-align: top;
            }
            td[rowspan] {
                vertical-align: middle !important;
                text-align: center !important;
            }
            @page {
                margin: 10mm;
            }
        </style>
    `;

            return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>${userName} Itinerary - ${monthName} ${selectedYear}</title>
            ${dynamicStyles}
        </head>
        <body>
            ${tableHtml}
        </body>
        </html>
    `;
        }

        // Firebase data fetching with improved row merging logic
        if (userEmail && userEmail !== '') {
            const safeUserEmail = userEmail.replace(/\./g, '_');
            const fieldReportRef = database.ref(`apps/uesi/staff-work/users/${safeUserEmail}/userData/Itinerary_Form`);

            if (fieldReportRef && selectedYear && selectedMonthNum) {
                document.getElementById('loader').style.display = 'block';
                document.getElementById('exportReportBtn').style.display = 'none';

                fieldReportRef.orderByKey()
                    .startAt(`${selectedYear}-${String(selectedMonthNum).padStart(2, '0')}-01`)
                    .endAt(`${selectedYear}-${String(selectedMonthNum).padStart(2, '0')}-31`)
                    .once('value', function (snapshot) {
                        document.getElementById('loader').style.display = 'none';

                        const rawData = [];
                        snapshot.forEach(function (dateSnapshot) {
                            const dateKey = dateSnapshot.key;
                            const dateData = dateSnapshot.val();
                            if (dateData && typeof dateData === 'object') {
                                rawData.push({
                                    date: dateKey,
                                    zone: dateData.zone || '',
                                    purpose: dateData.purpose || '',
                                    day: dateData.day || ''
                                });
                            }
                        });

                        // Sort by date to ensure correct grouping
                        rawData.sort((a, b) => new Date(a.date) - new Date(b.date));

                        if (rawData.length === 0) {
                            document.getElementById('noDataMessage').style.display = 'block';
                            document.getElementById('reportContent').style.display = 'block';
                            document.getElementById('exportReportBtn').style.display = 'none';
                            return;
                        }

                        // Use the new function to process and populate both display table and export data
                        processAndPopulateTable(rawData);
                    })
                    .catch(function (error) {
                        document.getElementById('loader').style.display = 'none';
                        document.getElementById('noDataMessage').textContent = `Error fetching data: ${error.message}`;
                        document.getElementById('noDataMessage').style.display = 'block';
                        document.getElementById('reportContent').style.display = 'block';
                        console.error("Firebase data fetch error:", error);
                    });
            }
        }
    </script>
</body>

</html>
